# Управление микросервисами с использованием Terraform, Vagrant, Ansible и Docker

## Описание

Этот проект направлен на автоматизацию создания ВМ с помощью Vagrant, развертывания микросервиса на виртуальной машине с использованием Ansible. Микросервис представляет собой HTTP-сервер, экспортирующий метрики для Prometheus. Система использует Docker для контейнеризации и настройки окружения для микросервиса. В качестве инструмента для управления инфраструктурой используется Terraform.

## Структура проекта

Проект включает следующие компоненты:

- `README.md` - Документация проекта.
- `Vagrantfile` - Конфигурация для создания виртуальной машины с использованием Vagrant.
- `ansible/` - Директория с playbook и ролями для Ansible.
  - `deploy.yml` - Главный Ansible playbook для развертывания микросервиса.
  - `inventory` - Файл инвентаря для Ansible.
  - `roles/` - Роли Ansible.
    - `deploy_docker/` - Роль для развертывания Docker.
      - `tasks/main.yml` - Задачи для установки и настройки Docker.
    - `deploy_server/` - Роль для развертывания микросервиса.
      - `tasks/main.yml` - Задачи для настройки и запуска микросервиса.
    - `install_docker/` - Роль для установки Docker на виртуальной машине.
      - `tasks/main.yml` - Задачи для установки Docker.
- `main.tf` - Файл конфигурации Terraform для создания и управления инфраструктурой.
- `microservice/` - Директория с кодом микросервиса.
  - `Dockerfile` - Dockerfile для создания контейнера с микросервисом.
  - `app.py` - Основной скрипт микросервиса, который экспортирует метрики.
  - `requirements.txt` - Зависимости Python для микросервиса.

## Установка

### 1. Установите зависимости

Для работы с проектом вам необходимо установить следующие инструменты:

- Vagrant
- Ansible
- Terraform

### 2. Инициализация Terraform

Перед развертыванием инфраструктуры с помощью Terraform выполните команду `terraform init` для инициализации проекта и загрузки необходимых плагинов:

bash: terraform init

### 3. Развертывание инфраструктуры

Для развертывания виртуальной машины и настройки окружения используйте команду terraform apply:

bash: terraform apply

Terraform создаст виртуальную машину и выполнит Ansible playbook для развертывания. Микросервис развернется в контейнере.

!!Важно!! Корневая папка проекта должна называться kasp.

### 4. Переключение метода развертывания

В файле main.tf можно выбрать один из двух методов развертывания:
docker: развертывание микросервиса в Docker-контейнере.
server: развертывание микросервиса непосредственно на сервере (без Docker).

Чтобы переключить метод развертывания, измените значение переменной deploy_method в файле main.tf:

rovisioner "local-exec" {
    command = "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ./ansible/inventory ./ansible/deploy.yml -e deploy_method=server"
  }

### 5. Пример работы микросервиса

После успешного развертывания микросервис будет доступен по адресу http://192.168.56.10:8080. Микросервис будет экспортировать метрики для Prometheus.